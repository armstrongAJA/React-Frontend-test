<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Weather App</title>
  
  <!-- React + ReactDOM UMD builds -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Babel for JSX compilation in the browser -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <style>
    body { font-family: sans-serif; margin: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    td, th { border: 1px solid #ccc; padding: 8px; text-align: center; }
  </style>
</head>
<body>
  <h1>7-Day Weather Forecast</h1>
  
  <div id="root"></div>

  <!-- Auth logic -->
<script type="text/babel">
// --- Auth logic ---
window.accessToken = null;
window.isAuthenticated = false;

// function to initialize Auth0 and get token
window.initAuth0 = async function() {
    const params = new URLSearchParams(window.location.search);
    if (params.has("code")) {
        try {
            const code = params.get("code");
            const verifier = localStorage.getItem("pkce_verifier");

            const res = await fetch("https://weatherapp-3o2e.onrender.com/weather", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ code, verifier }),
            });

            if (!res.ok) throw new Error("Token exchange failed");

            const data = await res.json();
            window.accessToken = data.access_token;
            window.isAuthenticated = true;
            localStorage.setItem("access_token", window.accessToken);

            window.history.replaceState({}, document.title, window.location.pathname);
        } catch (err) {
            console.error("Error during token exchange:", err);
        }
    } else {
        const storedToken = localStorage.getItem("access_token");
        if (storedToken) {
            window.accessToken = storedToken;
            window.isAuthenticated = true;
        }
    }
    return window.isAuthenticated;
};

// login
window.login = async function() {
    const verifier = generateCodeVerifier();
    localStorage.setItem("pkce_verifier", verifier);

    const challenge = await generateCodeChallenge(verifier);
    const authUrl = `https://${AUTH0_DOMAIN}/authorize?` +
        `response_type=code&` +
        `client_id=${AUTH0_CLIENT_ID}&` +
        `redirect_uri=${encodeURIComponent(REDIRECT_URI)}&` +
        `scope=openid profile email&` +
        `audience=${encodeURIComponent(AUDIENCE)}&` +
        `code_challenge=${challenge}&` +
        `code_challenge_method=S256`;

    window.location.href = authUrl;
};

// logout
window.logout = function() {
    localStorage.removeItem("access_token");
    localStorage.removeItem("pkce_verifier");
    window.isAuthenticated = false;
    window.accessToken = null;
    window.location.href = `https://${AUTH0_DOMAIN}/v2/logout?client_id=${AUTH0_CLIENT_ID}&returnTo=${RETURN_TO}`;
};

// get access token
window.getAccessToken = function() {
    return window.accessToken;
};

// update UI buttons
window.updateUI = function() {
    const loginBtn = document.getElementById("login-btn");
    const logoutBtn = document.getElementById("logout-btn");
    if (loginBtn) loginBtn.style.display = window.isAuthenticated ? "none" : "inline-block";
    if (logoutBtn) logoutBtn.style.display = window.isAuthenticated ? "inline-block" : "none";
};

// --- Helpers ---
function generateCodeVerifier() {
    const array = new Uint32Array(56);
    window.crypto.getRandomValues(array);
    return Array.from(array, dec => ("0" + dec.toString(16)).substr(-2)).join("");
}

async function generateCodeChallenge(verifier) {
    const encoder = new TextEncoder();
    const data = encoder.encode(verifier);
    const digest = await window.crypto.subtle.digest("SHA-256", data);
    return btoa(String.fromCharCode(...new Uint8Array(digest)))
        .replace(/\+/g, "-")
        .replace(/\//g, "_")
        .replace(/=+$/, "");
}

// --- Auth0 config ---
const AUTH0_DOMAIN = "dev-48b12ypfjnzz7foo.us.auth0.com";
const AUTH0_CLIENT_ID = "noq30FodeeaQqjfpwSCXEV1uXWqs42rG";
const REDIRECT_URI = "https://armstrongaja.github.io/React-Frontend-test/about.html";
const AUDIENCE = "https://dev-48b12ypfjnzz7foo.us.auth0.com/api/v2/";
const RETURN_TO = "https://armstrongaja.github.io/React-Frontend-test/about.html";
</script>


  <!-- Weather App -->
  <script type="text/babel">
    const { useState, useEffect, Fragment } = React;

    function WeatherApp() {
      const [location, setLocation] = useState("Leeds");
      const [lat, setLat] = useState(null);
      const [lon, setLon] = useState(null);
      const [weatherData, setWeatherData] = useState(null);
      const [loading, setLoading] = useState(false);
      const [isAuthenticated, setIsAuthenticated] = useState(false);

      const formatDate = dateStr => {
        const d = new Date(dateStr);
        return d.toLocaleDateString(undefined, { weekday: "short", month: "short", day: "numeric" });
      };

      const getLatLong = async loc => {
        try {
          const res = await fetch(`https://nominatim.openstreetmap.org/search?city=${loc}&country=united%20kingdom&format=json`);
          const result = await res.json();
          if (!result[0]) throw new Error("No results");
          return [parseFloat(result[0].lat), parseFloat(result[0].lon)];
        } catch {
          return [null, null];
        }
      };

      const buildApiUrl = () => `https://weatherapp-3o2e.onrender.com/weather?lat=${lat}&lon=${lon}&LOCATION=${location}`;

      const fetchWeatherData = async token => {
        try {
          const res = await fetch(buildApiUrl(), { headers: { Authorization: `Bearer ${token}` } });
          if (!res.ok) throw new Error("Fetch failed");
          return await res.json();
        } catch {
          alert("Failed to load weather data");
          return null;
        }
      };

      const initWeather = async token => {
        setLoading(true);
        const [latitude, longitude] = await getLatLong(location);
        if (!latitude || !longitude) {
          alert("Failed to get coordinates");
          setLoading(false);
          return;
        }
        setLat(latitude);
        setLon(longitude);
        const data = await fetchWeatherData(token);
        setWeatherData(data);
        setLoading(false);
      };

      useEffect(() => {
        (async () => {
          const auth = await window.initAuth0();
          setIsAuthenticated(auth);
          await window.updateUI();
          if (auth) {
            const token = window.getAccessToken();
            if (token) await initWeather(token);
          }
        })();
      }, []);

      useEffect(() => {
        if (isAuthenticated) {
          const token = window.getAccessToken();
          if (token) initWeather(token);
        }
      }, [location]);

      return (
        <div>
          <header>
            <h1>7-Day Weather Forecast ({location})</h1>
            <button onClick={window.login}>Login</button>
            <button onClick={window.logout}>Logout</button>
            <select value={location} onChange={e => setLocation(e.target.value)}>
              <option value="Leeds">Leeds</option>
              <option value="London">London</option>
              <option value="Manchester">Manchester</option>
            </select>
          </header>

          {loading && <p>Loading...</p>}

          {!loading && weatherData && (
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Max Temp (Â°C)</th>
                  <th>Weather</th>
                </tr>
              </thead>
              <tbody>
                {weatherData.data_day.time.map((time, i) => (
                  <tr key={i}>
                    <td>{formatDate(time)}</td>
                    <td>{weatherData.data_day.temperature_max[i].toFixed(1)}</td>
                    <td>Weather info</td>
                  </tr>
                ))}
              </tbody>
            </table>
          )}
        </div>
      );
    }

    ReactDOM.render(<WeatherApp />, document.getElementById("root"));
  </script>
</body>
</html>
